# Flutter移动端图片生成功能使用指南

## 功能概述

Arcaea Helper 移动端现已支持直接在手机上生成 B30/R10 精美图片，无需依赖电脑端或Node.js环境。

## 使用步骤

### 1. 打开Arcaea查分页面

1. 在应用中打开 `https://arcaea.lowiro.com`
2. 登录你的Arcaea账号
3. 进入 **Profile - Potential** 页面
4. 等待页面完全加载（包括所有歌曲卡片、定数、PTT等数据）

### 2. 生成图片

有两种方式生成图片：

#### 方式一：使用顶部工具栏按钮（推荐）

1. 当页面数据加载完成后，顶部工具栏会出现图片图标按钮 📷
2. 点击该按钮即可开始生成图片
3. 等待生成过程完成（会显示进度提示）
4. 生成完成后会自动打开分享面板

#### 方式二：使用设置面板

1. 点击顶部的设置图标 ⚙️
2. 在设置面板中找到 **"生成B30/R10图片"** 按钮
3. 点击按钮开始生成
4. 等待生成完成并分享

### 3. 保存或分享图片

- 图片生成完成后，系统会自动打开分享面板
- 你可以选择：
  - 保存到相册
  - 分享到社交媒体（微信、QQ、微博等）
  - 发送给好友
  - 或其他系统支持的分享方式

## 生成的图片内容

生成的图片包含：

### 顶部区域
- **玩家用户名**（居中显示）
- **总PTT**（显示为 `总PTT: XX.XXXX`）
- **B30平均PTT**（显示为 `B30: XX.XXXX`）
- **R10平均PTT**（显示为 `R10: XX.XXXX`）
- **导出时间**

### 卡片区域（8行5列，共40张卡片）

每张歌曲卡片包含：
- **排名标签**：
  - Best 30：金色 `#1` - `#30`
  - Recent 10：绿色 `R1` - `R10`
- **歌曲名称**（最多显示2行）
- **难度标签**（彩色圆角背景）：PST/PRS/FTR/BYD/ETR
- **分数**（格式：`XX' XXX' XXX`）
- **评级**：PM/EX+/EX/AA/A/B/C/D
- **谱面定数**（显示为 `定数: XX.X`）
- **单曲PTT**（蓝色加粗，显示为 `PTT: XX.XXXX`）
- **目标分数**（绿色，格式：`>> XX' XXX' XXX`）
  - 显示达到当前显示PTT +0.01 所需的分数
  - 仅在未达到PM且有可提升空间时显示
- **曲绘背景**（半透明显示）

### 底部区域
- 生成工具标识：`Generated by Arcaea Online Helper`

## 图片规格

- **分辨率**：2400 x 3900 像素
- **格式**：PNG
- **纵横比**：2:3（竖向）
- **文件大小**：约 2-5 MB（取决于内容复杂度）

## 注意事项

### 权限要求

- **Android**：首次使用时会请求存储权限，用于保存图片
- **iOS**：会使用系统相册权限（通过分享面板自动处理）

### 网络要求

- 生成图片时会尝试加载曲绘（封面图），需要网络连接
- 如果网络较慢或曲绘加载失败，图片仍会正常生成，只是卡片背景会是纯色

### 性能提示

- 生成图片需要处理大量数据和图形渲染，可能需要 10-30 秒
- 生成过程中会显示实时进度提示
- 生成期间请不要切换应用或锁屏，以免中断处理

### 数据准确性

- 图片数据来源于当前页面显示的内容
- 请确保页面已完全加载所有数据
- 定数和PTT计算基于内置的 `ChartConstant.json` 数据
- 如果页面数据不完整，生成的图片可能缺少部分信息

## 故障排除

### 问题：点击按钮没有反应

**可能原因**：
1. 页面数据尚未完全加载
2. 网络连接问题

**解决方法**：
1. 等待页面完全加载（所有卡片都显示定数和PTT）
2. 下拉刷新页面
3. 重新加载页面（点击刷新按钮）

### 问题：生成过程中卡住

**可能原因**：
1. 网络缓慢导致曲绘加载超时
2. 内存不足

**解决方法**：
1. 等待更长时间（最多1-2分钟）
2. 关闭其他应用释放内存
3. 重启应用后重试

### 问题：图片中曲绘显示不完整

**可能原因**：
- 部分曲绘URL无法访问或加载失败

**说明**：
- 这是正常现象，不影响图片其他内容
- 加载失败的曲绘会显示为纯色背景

### 问题：分享面板显示异常

**可能原因**：
- 系统分享服务异常

**解决方法**：
1. 图片已生成并保存在应用临时目录
2. 可以通过文件管理器找到并手动分享
3. 或重新生成一次

## 技术细节

### 数据流程

1. **数据获取**：从WebView中的页面提取B30/R10数据
2. **数据解析**：将HTML元素转换为结构化的JSON数据
3. **PTT计算**：根据分数和定数计算单曲PTT和目标分数
4. **图片渲染**：使用Flutter Canvas API绘制完整图片
5. **图片保存**：将渲染结果保存为PNG文件
6. **分享**：调用系统分享功能

### 核心模块

- **数据模型**：`lib/models/b30r10_data.dart`
- **配置文件**：`lib/services/image_generator_config.dart`
- **生成服务**：`lib/services/image_generator_service.dart`
- **JavaScript桥接**：`shared_core/js/flutter-content.js`

### 与Node.js版本的对比

| 特性 | Node.js版本 | Flutter移动端版本 |
|------|------------|------------------|
| 运行环境 | 需要Node.js和npm | 仅需Flutter应用 |
| 数据来源 | 手动导出JSON文件 | 自动从页面提取 |
| 字体支持 | 可自定义字体 | 使用系统字体 |
| 图片质量 | 高质量PNG | 高质量PNG |
| 生成速度 | 5-10秒 | 10-30秒 |
| 便捷性 | 需要电脑 | 手机直接生成 |

## 更新日志

### v1.0.0 - 2024-12-01
- ✨ 首次发布移动端图片生成功能
- ✨ 支持自动从页面提取B30/R10数据
- ✨ 支持生成2400x3900高分辨率图片
- ✨ 支持曲绘背景和目标分数显示
- ✨ 集成系统分享功能

## 反馈与建议

如果你在使用过程中遇到问题或有改进建议，欢迎：

1. 在GitHub仓库提交Issue
2. 通过应用内的反馈渠道联系开发者
3. 加入讨论群组分享你的想法

---

**感谢使用 Arcaea Online Helper！**
